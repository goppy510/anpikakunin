# プロジェクト知見

## 実装パターン

### 地震イベント重複検知
- `eventId` + `payloadHash` の組み合わせでユニーク制約
- SHA-256ハッシュでペイロード全体を比較
- Prismaの `P2002` エラーコードで重複を判定

### Slackトークン暗号化
- AES-256-GCM アルゴリズムを使用
- `ciphertext`, `iv`, `authTag` を別カラムで保存
- 暗号化キーは環境変数 `SLACK_TOKEN_ENCRYPTION_KEY` から取得

### WebSocket再接続
- 切断時は指数バックオフで再接続
- 最大5回リトライ後、エラー通知

### データベース設計
- ワークスペースと通知設定は1:1関係
- `ON DELETE CASCADE` で関連データを自動削除
- インデックスは頻繁に検索するカラムに設定

## アーキテクチャ選択理由

### なぜPrisma?
- 型安全なクエリ
- マイグレーション管理が容易
- PostgreSQL固有機能（JSONB、配列型）をサポート

### なぜIndexedDB?
- オフライン時もイベント履歴を閲覧可能
- ブラウザローカルで高速アクセス
- PostgreSQLは長期保存用、IndexedDBは短期キャッシュ用

### なぜNext.js API Routes?
- フロントエンドとバックエンドを統合
- サーバーレス環境にデプロイ可能
- 環境変数を安全に扱える

## 避けるべきパターン

### ❌ やってはいけないこと
- WebSocketの同時接続数を増やしすぎる（料金増加）
- フロントエンドでSlack Bot Tokenを扱う（セキュリティリスク）
- 地震イベントを毎回全件取得（パフォーマンス低下）
- マイグレーションファイルを手動編集（Prismaに任せる）

### ✅ 推奨パターン
- 環境変数で設定を切り替え（本番/ステージング/ローカル）
- ログは構造化JSON形式で出力
- エラーは必ずログに記録してからユーザーに通知
