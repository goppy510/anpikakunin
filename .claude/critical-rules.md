# 重要ルール - 絶対に守ること

## 📛 禁止事項（事前確認なしで実行禁止）

### データベース操作
- ❌ `prisma migrate reset`
- ❌ `prisma migrate resolve --rolled-back`
- ❌ `DROP TABLE` / `DROP DATABASE`
- ❌ `DELETE FROM` / `TRUNCATE`
- ❌ データベースボリュームの削除
- ❌ スキーマ変更を伴うマイグレーション

### ファイル・ディレクトリ操作
- ❌ `rm -rf` でのディレクトリ削除
- ❌ `git rm` での追跡ファイル削除
- ❌ 既存ページ・コンポーネントの削除
- ❌ 既存機能の大幅な変更

### インフラ操作
- ❌ `docker-compose down -v` (ボリューム削除)
- ❌ Docker ボリュームの削除
- ❌ 環境変数の削除・変更
- ❌ `.env` ファイルの変更

## ✅ エラー発生時の対応フロー

```
1. エラー内容を正確に報告
   ↓
2. 現在の状態を確認・報告
   ↓
3. 複数の対応案を提示（それぞれのリスクも明記）
   ↓
4. プロジェクトマネージャーの指示を待つ
   ↓
5. 指示された方法のみ実行
```

## 📋 マイグレーションエラー時の対応テンプレート

```markdown
マイグレーションでエラーが発生しました。

【エラー内容】
<エラーメッセージ>

【原因】
<エラーの原因を説明>

【現在の状態】
- データベース: <テーブル数、レコード数>
- マイグレーション状態: <最後に成功したマイグレーション>

【対応方法の選択肢】
1. マイグレーションファイルを手動修正
   - リスク: なし
   - 影響: なし

2. マイグレーションをスキップ
   - リスク: スキーマ不整合の可能性
   - 影響: 一部機能が動作しない可能性

3. データベースリセット
   - リスク: 全データ消失
   - 影響: 全データ再投入が必要

どの方法で対応しますか？
```

## 🔍 事前確認が必要な操作の判断基準

### 自分で判断してよい操作
- ✅ ファイルの読み取り
- ✅ コードの検索・調査
- ✅ ログの確認
- ✅ 新規ファイルの作成（既存に影響しない）
- ✅ Git の状態確認
- ✅ データベースの参照（SELECT）

### 必ず確認が必要な操作
- ⚠️ データの削除・変更
- ⚠️ 既存ファイルの削除
- ⚠️ 既存ファイルの大幅な変更
- ⚠️ データベーススキーマ変更
- ⚠️ インフラ設定変更
- ⚠️ 依存パッケージの追加・削除
- ⚠️ 環境変数の変更

## 📝 確認時のテンプレート

### データ削除を伴う操作
```markdown
以下の操作はデータを削除する可能性があります:

【操作内容】
<具体的なコマンド>

【影響範囲】
- 削除されるデータ: <具体的に>
- 影響するテーブル/ファイル: <リスト>

【復元方法】
- バックアップ: <有無>
- Git履歴: <有無>
- 復元可否: <可能/不可能>

実行してよろしいですか？
```

## 🚨 過去の重大インシデント

### 2025-10-10: マイグレーション操作によるデータ消失
**問題**: `prisma migrate resolve --rolled-back` を確認なしで実行し、全データが消失

**原因**:
- マイグレーションエラー時に勝手に判断
- データ消失のリスクを考慮せず実行
- プロジェクトマネージャーへの確認なし

**学んだこと**:
- マイグレーション操作は必ず事前確認
- エラー時は複数の選択肢を提示
- データベース操作は慎重に

**再発防止策**: このドキュメントの作成と遵守

## 🎯 行動原則

1. **疑わしい時は確認する**
   - 「これは大丈夫だろう」は禁物
   - 少しでも不安なら確認

2. **影響範囲を常に考える**
   - この操作で何が変わるか
   - 元に戻せるか
   - 他に影響はないか

3. **プロジェクトマネージャーの時間を尊重する**
   - 明確な選択肢を提示
   - 必要な情報を全て含める
   - 何度も聞き直さない

4. **記録を残す**
   - 重要な操作は記録
   - エラーは詳細に記録
   - 判断理由も記録

---

**このドキュメントは必ず遵守すること**
