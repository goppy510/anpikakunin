generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model EarthquakeEventLog {
  id          Int      @id @default(autoincrement())
  eventId     String   @map("event_id")
  payloadHash String   @map("payload_hash")
  source      String
  payload     Json
  fetchedAt   DateTime @default(now()) @map("fetched_at")

  @@map("earthquake_event_logs")
  @@unique([eventId, payloadHash], map: "earthquake_event_logs_event_id_payload_hash_key")
  @@index([eventId], map: "idx_earthquake_event_logs_event_id")
}

model SlackWorkspace {
  id                 String                     @id @default(uuid())
  workspaceId        String                     @unique @map("workspace_id")
  name               String
  botTokenCiphertext String                     @map("bot_token_ciphertext") // base64 encoded
  botTokenIv         String                     @map("bot_token_iv")         // base64 encoded
  botTokenTag        String                     @map("bot_token_tag")        // base64 encoded
  isEnabled          Boolean                    @default(true) @map("is_enabled")
  createdAt          DateTime                   @default(now()) @map("created_at")
  updatedAt          DateTime                   @updatedAt @map("updated_at")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  departments        Department[]
  notificationCondition EarthquakeNotificationCondition?
  notificationChannels NotificationChannel[]
  messageTemplates   MessageTemplate[]
  spreadsheetConfig  SpreadsheetConfig?
  users              UserWorkspace[]

  @@map("slack_workspaces")
  @@index([workspaceId], map: "idx_slack_workspaces_workspace_id")
}

// é€šçŸ¥ãƒãƒ£ãƒ³ãƒãƒ«è¨­å®šï¼ˆæ–°è¨­è¨ˆï¼‰
model NotificationChannel {
  id           String         @id @default(uuid())
  workspaceRef String         @map("workspace_ref")
  workspace    SlackWorkspace @relation(fields: [workspaceRef], references: [id], onDelete: Cascade)
  channelId    String         @map("channel_id") // Slackãƒãƒ£ãƒ³ãƒãƒ«ID
  channelName  String         @map("channel_name") // ãƒãƒ£ãƒ³ãƒãƒ«åï¼ˆè¡¨ç¤ºç”¨ï¼‰
  purpose      String         // "earthquake" | "safety_confirmation" | "general"
  isActive     Boolean        @default(true) @map("is_active")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  @@map("notification_channels")
  @@index([workspaceRef, purpose])
  @@unique([workspaceRef, channelId, purpose])
}

// éƒ¨ç½²ã‚¹ã‚¿ãƒ³ãƒ—è¨­å®š
model Department {
  id           String         @id @default(uuid())
  workspaceRef String         @map("workspace_ref")
  workspace    SlackWorkspace @relation(fields: [workspaceRef], references: [id], onDelete: Cascade)
  name         String         // éƒ¨ç½²åï¼ˆä¾‹: "é–‹ç™º", "ãƒãƒ¼ã‚±"ï¼‰
  slackEmoji   String         @map("slack_emoji") // Slackçµµæ–‡å­—å½¢å¼ï¼ˆä¾‹: ":dev:"ï¼‰
  buttonColor  String         @map("button_color") // ãƒœã‚¿ãƒ³ã®è‰²ï¼ˆä¾‹: "#5B8FF9"ï¼‰
  displayOrder Int            @default(0) @map("display_order") // è¡¨ç¤ºé †åº
  isActive     Boolean        @default(true) @map("is_active")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  @@map("departments")
  @@index([workspaceRef])
  @@index([workspaceRef, displayOrder])
}

// åœ°éœ‡é€šçŸ¥æ¡ä»¶è¨­å®š
model EarthquakeNotificationCondition {
  id                 String         @id @default(uuid())
  workspaceRef       String         @unique @map("workspace_ref")
  workspace          SlackWorkspace @relation(fields: [workspaceRef], references: [id], onDelete: Cascade)
  minIntensity       String         @map("min_intensity") // æœ€å°éœ‡åº¦ï¼ˆä¾‹: "5-"ï¼‰
  targetPrefectures  String[]       @map("target_prefectures") // å¯¾è±¡éƒ½é“åºœçœŒãƒªã‚¹ãƒˆ
  channelId          String         @map("channel_id") // Slackãƒãƒ£ãƒ³ãƒãƒ«ï¿½ID
  isEnabled          Boolean        @default(true) @map("is_enabled")
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")

  @@map("earthquake_notification_conditions")
  @@index([workspaceRef])
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
enum MessageTemplateType {
  PRODUCTION // æœ¬ç•ªç”¨
  TRAINING   // è¨“ç·´ç”¨
}

model MessageTemplate {
  id           String              @id @default(uuid())
  workspaceRef String              @map("workspace_ref")
  workspace    SlackWorkspace      @relation(fields: [workspaceRef], references: [id], onDelete: Cascade)
  type         MessageTemplateType // æœ¬ç•ª or è¨“ç·´
  title        String              // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«
  body         String              @db.Text // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡
  isActive     Boolean             @default(true) @map("is_active")
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")

  @@map("message_templates")
  @@index([workspaceRef, type])
  @@unique([workspaceRef, type], name: "unique_workspace_type")
}

// ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLç®¡ç†
model SpreadsheetConfig {
  id           String         @id @default(uuid())
  workspaceRef String         @unique @map("workspace_ref")
  workspace    SlackWorkspace @relation(fields: [workspaceRef], references: [id], onDelete: Cascade)
  spreadsheetUrl String       @map("spreadsheet_url") // Google Spreadsheetã®URL
  isEnabled    Boolean        @default(true) @map("is_enabled")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  @@map("spreadsheet_configs")
  @@index([workspaceRef])
}

// ===== ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« =====

// éƒ½é“åºœçœŒãƒã‚¹ã‚¿ãƒ¼
model Prefecture {
  id          Int      @id @default(autoincrement())
  code        String   @unique // JISéƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: "13" = æ±äº¬éƒ½ï¼‰
  name        String   @unique // éƒ½é“åºœçœŒåï¼ˆä¾‹: "æ±äº¬éƒ½"ï¼‰
  nameKana    String   @map("name_kana") // ãµã‚ŠãŒãªï¼ˆä¾‹: "ã¨ã†ãã‚‡ã†ã¨"ï¼‰
  region      String   // åœ°åŸŸåŒºåˆ†ï¼ˆä¾‹: "é–¢æ±"ï¼‰
  displayOrder Int     @default(0) @map("display_order") // è¡¨ç¤ºé †åº
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("prefectures")
  @@index([code])
  @@index([region])
}

// éœ‡åº¦ãƒã‚¹ã‚¿ãƒ¼
model IntensityScale {
  id          Int      @id @default(autoincrement())
  value       String   @unique // APIå€¤ï¼ˆä¾‹: "5-", "5+", "6-", "6+", "7"ï¼‰
  displayName String   @map("display_name") // è¡¨ç¤ºåï¼ˆä¾‹: "éœ‡åº¦5å¼±ä»¥ä¸Š"ï¼‰
  shortName   String   @map("short_name") // çŸ­ç¸®åï¼ˆä¾‹: "5å¼±"ï¼‰
  numericValue Decimal @map("numeric_value") @db.Decimal(3, 1) // æ•°å€¤åŒ–ã—ãŸå€¤ï¼ˆæ¯”è¼ƒç”¨: 5.0, 5.5, 6.0, 6.5, 7.0ï¼‰
  displayOrder Int     @default(0) @map("display_order") // è¡¨ç¤ºé †åº
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("intensity_scales")
  @@index([value])
  @@index([numericValue])
}

// èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ 

enum UserRole {
  ADMIN  // ç®¡ç†è€…æ¨©é™: ã™ã¹ã¦ã®è¨­å®šå¯èƒ½
  EDITOR // è¨­å®šæ¨©é™: åœ°éœ‡é€šçŸ¥è¨­å®šã®ã¿
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String?   @map("password_hash") // null = æœªè¨­å®šï¼ˆæ‹›å¾…ä¸­ï¼‰
  role          UserRole  @default(EDITOR)
  isActive      Boolean   @default(true) @map("is_active")
  emailVerified Boolean   @default(false) @map("email_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  sessions      Session[]
  otpCodes      OtpCode[]
  invitationsSent UserInvitation[] @relation("InviterRelation")
  workspaces    UserWorkspace[]
  groupMemberships UserGroupMembership[]
  permissionAttachments UserPermissionAttachment[]

  @@map("users")
}

// ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆAWS IAMã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
model Group {
  id          String   @id @default(uuid())
  name        String   @unique // ã‚°ãƒ«ãƒ¼ãƒ—åï¼ˆä¾‹: "ç®¡ç†è€…ã‚°ãƒ«ãƒ¼ãƒ—", "é–²è¦§è€…ã‚°ãƒ«ãƒ¼ãƒ—"ï¼‰
  description String?  @db.Text // ã‚°ãƒ«ãƒ¼ãƒ—ã®èª¬æ˜
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  members     UserGroupMembership[]
  permissions GroupPermissionAttachment[]

  @@map("groups")
  @@index([name])
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«
model UserGroupMembership {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId   String   @map("group_id")
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("user_group_memberships")
  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
}

// æ¨©é™ãƒã‚¹ã‚¿ãƒ¼
model Permission {
  id          String   @id @default(uuid())
  name        String   @unique // æ¨©é™åï¼ˆä¾‹: "slack:workspace:write", "earthquake:condition:read"ï¼‰
  displayName String   @map("display_name") // è¡¨ç¤ºåï¼ˆä¾‹: "Slackãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ç·¨é›†"ï¼‰
  description String?  @db.Text // æ¨©é™ã®èª¬æ˜
  category    String   // ã‚«ãƒ†ã‚´ãƒªï¼ˆä¾‹: "slack", "earthquake", "user"ï¼‰
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  groupAttachments GroupPermissionAttachment[]
  userAttachments  UserPermissionAttachment[]

  @@map("permissions")
  @@index([category])
  @@index([name])
}

// ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»æ¨©é™ã®ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆ
model GroupPermissionAttachment {
  id           String     @id @default(uuid())
  groupId      String     @map("group_id")
  group        Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  permissionId String     @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now()) @map("created_at")

  @@map("group_permission_attachments")
  @@unique([groupId, permissionId])
  @@index([groupId])
  @@index([permissionId])
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»æ¨©é™ã®ç›´æ¥ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆ
model UserPermissionAttachment {
  id           String     @id @default(uuid())
  userId       String     @map("user_id")
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permissionId String     @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now()) @map("created_at")

  @@map("user_permission_attachments")
  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
}

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒã‚¹ã‚¿ãƒ¼
model Menu {
  id                 String   @id @default(uuid())
  name               String   // ãƒ¡ãƒ‹ãƒ¥ãƒ¼åï¼ˆä¾‹: "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹"ï¼‰
  path               String   @unique // ãƒ‘ã‚¹ï¼ˆä¾‹: "/admin/workspaces"ï¼‰
  icon               String   // ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆä¾‹: "ğŸ”—"ï¼‰
  displayOrder       Int      @map("display_order") // è¡¨ç¤ºé †åº
  isActive           Boolean  @default(true) @map("is_active")
  categoryPermission String   @map("category_permission") // ã“ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–²è¦§ã«å¿…è¦ãªæ¨©é™ï¼ˆä¾‹: "workspace:read"ï¼‰
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@map("menus")
  @@index([displayOrder])
  @@index([isActive])
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«
model UserWorkspace {
  id           String         @id @default(uuid())
  userId       String         @map("user_id")
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspaceRef String         @map("workspace_ref")
  workspace    SlackWorkspace @relation(fields: [workspaceRef], references: [id], onDelete: Cascade)
  createdAt    DateTime       @default(now()) @map("created_at")

  @@map("user_workspaces")
  @@unique([userId, workspaceRef])
  @@index([userId])
  @@index([workspaceRef])
}

model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
  @@index([userId])
  @@index([token])
}

model OtpCode {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  code      String   // 6æ¡æ•°å­—
  expiresAt DateTime @map("expires_at") // 5åˆ†å¾Œ
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("otp_codes")
  @@index([userId])
  @@index([code, expiresAt])
}

model UserInvitation {
  id         String    @id @default(uuid())
  email      String
  invitedBy  String    @map("invited_by")
  token      String    @unique
  role       UserRole  @default(EDITOR)
  expiresAt  DateTime  @map("expires_at") // 7æ—¥å¾Œ
  acceptedAt DateTime? @map("accepted_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  inviter    User      @relation("InviterRelation", fields: [invitedBy], references: [id])

  @@map("user_invitations")
  @@index([email])
  @@index([token])
}
