generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model EarthquakeEventLog {
  id          Int      @id @default(autoincrement())
  eventId     String   @map("event_id")
  payloadHash String   @map("payload_hash")
  source      String
  payload     Json
  fetchedAt   DateTime @default(now()) @map("fetched_at")

  @@map("earthquake_event_logs")
  @@unique([eventId, payloadHash], map: "earthquake_event_logs_event_id_payload_hash_key")
  @@index([eventId], map: "idx_earthquake_event_logs_event_id")
}

model SlackWorkspace {
  id                 String                     @id @default(uuid())
  workspaceId        String                     @unique @map("workspace_id")
  name               String
  botTokenCiphertext String                     @map("bot_token_ciphertext") // base64 encoded
  botTokenIv         String                     @map("bot_token_iv")         // base64 encoded
  botTokenTag        String                     @map("bot_token_tag")        // base64 encoded
  isEnabled          Boolean                    @default(true) @map("is_enabled")
  createdAt          DateTime                   @default(now()) @map("created_at")
  updatedAt          DateTime                   @updatedAt @map("updated_at")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  departments        Department[]
  notificationCondition EarthquakeNotificationCondition?
  notificationChannels NotificationChannel[]
  messageTemplates   MessageTemplate[]
  users              UserWorkspace[]
  groups             Group[] // ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«ç´ã¥ãã‚°ãƒ«ãƒ¼ãƒ—
  invitations        UserInvitation[] // ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«ç´ã¥ãæ‹›å¾…
  earthquakeNotifications EarthquakeNotification[]
  trainingNotifications TrainingNotification[]
  notificationSnoozeConfig NotificationSnoozeConfig? // é€šçŸ¥ã‚¹ãƒŒãƒ¼ã‚ºè¨­å®š
  notificationSnooze NotificationSnooze? // é€šçŸ¥ã‚¹ãƒŒãƒ¼ã‚ºçŠ¶æ…‹

  @@map("slack_workspaces")
  @@index([workspaceId], map: "idx_slack_workspaces_workspace_id")
}

// é€šçŸ¥ãƒãƒ£ãƒ³ãƒãƒ«è¨­å®šï¼ˆæ–°è¨­è¨ˆï¼‰
model NotificationChannel {
  id           String         @id @default(uuid())
  workspaceRef String         @map("workspace_ref")
  workspace    SlackWorkspace @relation(fields: [workspaceRef], references: [id], onDelete: Cascade)
  channelId    String         @map("channel_id") // Slackãƒãƒ£ãƒ³ãƒãƒ«ID
  channelName  String         @map("channel_name") // ãƒãƒ£ãƒ³ãƒãƒ«åï¼ˆè¡¨ç¤ºç”¨ï¼‰
  purpose      String         // "earthquake" | "safety_confirmation" | "general"
  isActive     Boolean        @default(true) @map("is_active")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  @@map("notification_channels")
  @@index([workspaceRef, purpose])
  @@unique([workspaceRef, channelId, purpose])
}

// éƒ¨ç½²ã‚¹ã‚¿ãƒ³ãƒ—è¨­å®š
model Department {
  id           String         @id @default(uuid())
  workspaceRef String         @map("workspace_ref")
  workspace    SlackWorkspace @relation(fields: [workspaceRef], references: [id], onDelete: Cascade)
  name         String         // éƒ¨ç½²åï¼ˆä¾‹: "é–‹ç™º", "ãƒãƒ¼ã‚±"ï¼‰
  slackEmoji   String         @map("slack_emoji") // Slackçµµæ–‡å­—å½¢å¼ï¼ˆä¾‹: ":dev:"ï¼‰
  buttonColor  String         @map("button_color") // ãƒœã‚¿ãƒ³ã®è‰²ï¼ˆä¾‹: "#5B8FF9"ï¼‰
  displayOrder Int            @default(0) @map("display_order") // è¡¨ç¤ºé †åº
  isActive     Boolean        @default(true) @map("is_active")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  safetyResponses SafetyConfirmationResponse[]
  trainingResponses TrainingConfirmationResponse[]

  @@map("departments")
  @@index([workspaceRef])
  @@index([workspaceRef, displayOrder])
}

// åœ°éœ‡æƒ…å ±ç¨®åˆ¥ãƒã‚¹ã‚¿ãƒ¼
model EarthquakeInfoType {
  code        String                            @id // VXSE51, VXSE53
  name        String                            // éœ‡åº¦é€Ÿå ±, éœ‡æºãƒ»éœ‡åº¦æƒ…å ±
  description String                            @db.Text
  displayOrder Int                              @map("display_order")
  isActive    Boolean                           @default(true) @map("is_active")
  createdAt   DateTime                          @default(now()) @map("created_at")
  updatedAt   DateTime                          @default(now()) @updatedAt @map("updated_at")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  conditions  EarthquakeNotificationCondition[]

  @@map("earthquake_info_types")
}

// åœ°éœ‡é€šçŸ¥æ¡ä»¶è¨­å®š
model EarthquakeNotificationCondition {
  id                   String              @id @default(uuid())
  workspaceRef         String              @unique @map("workspace_ref")
  workspace            SlackWorkspace      @relation(fields: [workspaceRef], references: [id], onDelete: Cascade)
  earthquakeInfoType   String              @default("VXSE53") @map("earthquake_info_type") // VXSE51 or VXSE53
  infoType             EarthquakeInfoType  @relation(fields: [earthquakeInfoType], references: [code])
  minIntensity         String              @map("min_intensity") // æœ€å°éœ‡åº¦ï¼ˆä¾‹: "5-"ï¼‰
  targetPrefectures    String[]            @map("target_prefectures") // å¯¾è±¡éƒ½é“åºœçœŒãƒªã‚¹ãƒˆ
  channelId            String              @map("channel_id") // Slackãƒãƒ£ãƒ³ãƒãƒ«ID
  isEnabled            Boolean             @default(true) @map("is_enabled")
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")

  @@map("earthquake_notification_conditions")
  @@index([workspaceRef])
  @@index([earthquakeInfoType])
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
enum MessageTemplateType {
  PRODUCTION // æœ¬ç•ªç”¨
  TRAINING   // è¨“ç·´ç”¨
}

model MessageTemplate {
  id           String              @id @default(uuid())
  workspaceRef String              @map("workspace_ref")
  workspace    SlackWorkspace      @relation(fields: [workspaceRef], references: [id], onDelete: Cascade)
  type         MessageTemplateType // æœ¬ç•ª or è¨“ç·´
  title        String              // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«
  body         String              @db.Text // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡
  isActive     Boolean             @default(true) @map("is_active")
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")

  @@map("message_templates")
  @@index([workspaceRef, type])
  @@unique([workspaceRef, type], name: "unique_workspace_type")
}

// ===== ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« =====

// éƒ½é“åºœçœŒãƒã‚¹ã‚¿ãƒ¼
model Prefecture {
  id          Int      @id @default(autoincrement())
  code        String   @unique // JISéƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: "13" = æ±äº¬éƒ½ï¼‰
  name        String   @unique // éƒ½é“åºœçœŒåï¼ˆä¾‹: "æ±äº¬éƒ½"ï¼‰
  nameKana    String   @map("name_kana") // ãµã‚ŠãŒãªï¼ˆä¾‹: "ã¨ã†ãã‚‡ã†ã¨"ï¼‰
  region      String   // åœ°åŸŸåŒºåˆ†ï¼ˆä¾‹: "é–¢æ±"ï¼‰
  displayOrder Int     @default(0) @map("display_order") // è¡¨ç¤ºé †åº
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  earthquakeObservations EarthquakePrefectureObservation[]

  @@map("prefectures")
  @@index([code])
  @@index([region])
}

// éœ‡åº¦ãƒã‚¹ã‚¿ãƒ¼
model IntensityScale {
  id          Int      @id @default(autoincrement())
  value       String   @unique // APIå€¤ï¼ˆä¾‹: "5-", "5+", "6-", "6+", "7"ï¼‰
  displayName String   @map("display_name") // è¡¨ç¤ºåï¼ˆä¾‹: "éœ‡åº¦5å¼±ä»¥ä¸Š"ï¼‰
  shortName   String   @map("short_name") // çŸ­ç¸®åï¼ˆä¾‹: "5å¼±"ï¼‰
  numericValue Decimal @map("numeric_value") @db.Decimal(3, 1) // æ•°å€¤åŒ–ã—ãŸå€¤ï¼ˆæ¯”è¼ƒç”¨: 5.0, 5.5, 6.0, 6.5, 7.0ï¼‰
  displayOrder Int     @default(0) @map("display_order") // è¡¨ç¤ºé †åº
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("intensity_scales")
  @@index([value])
  @@index([numericValue])
}

// èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ 

enum UserRole {
  ADMIN  // ç®¡ç†è€…æ¨©é™: ã™ã¹ã¦ã®è¨­å®šå¯èƒ½
  EDITOR // è¨­å®šæ¨©é™: åœ°éœ‡é€šçŸ¥è¨­å®šã®ã¿
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String?   @map("password_hash") // null = æœªè¨­å®šï¼ˆæ‹›å¾…ä¸­ï¼‰
  role          UserRole  @default(EDITOR)
  isActive      Boolean   @default(true) @map("is_active")
  emailVerified Boolean   @default(false) @map("email_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  sessions      Session[]
  otpCodes      OtpCode[]
  passkeys      Passkey[] // ãƒ‘ã‚¹ã‚­ãƒ¼èªè¨¼
  invitationsSent UserInvitation[] @relation("InviterRelation")
  workspaces    UserWorkspace[]
  groupMemberships UserGroupMembership[]
  permissionAttachments UserPermissionAttachment[]
  activityLogs  ActivityLog[]
  passwordResetTokens PasswordResetToken[]

  @@map("users")
}

// ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆAWS IAMã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
model Group {
  id           String          @id @default(uuid())
  workspaceRef String?         @map("workspace_ref") // Slackãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å‚ç…§ï¼ˆã‚·ã‚¹ãƒ†ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã¯nullï¼‰
  workspace    SlackWorkspace? @relation(fields: [workspaceRef], references: [id], onDelete: Cascade)
  name         String          // ã‚°ãƒ«ãƒ¼ãƒ—åï¼ˆä¾‹: "ç®¡ç†è€…ã‚°ãƒ«ãƒ¼ãƒ—", "é–²è¦§è€…ã‚°ãƒ«ãƒ¼ãƒ—"ï¼‰
  description  String?         @db.Text // ã‚°ãƒ«ãƒ¼ãƒ—ã®èª¬æ˜
  isActive     Boolean         @default(true) @map("is_active")
  isSystem     Boolean         @default(false) @map("is_system") // ã‚·ã‚¹ãƒ†ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆç®¡ç†è€…ã‚°ãƒ«ãƒ¼ãƒ—ãªã©ï¼‰ã¯å‰Šé™¤ä¸å¯
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  members     UserGroupMembership[]
  permissions GroupPermissionAttachment[]
  invitations UserInvitation[]

  @@map("groups")
  @@unique([workspaceRef, name], name: "unique_workspace_group_name") // ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å†…ã§ã‚°ãƒ«ãƒ¼ãƒ—åã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯
  @@index([name])
  @@index([isSystem])
  @@index([workspaceRef])
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«
model UserGroupMembership {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId   String   @map("group_id")
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("user_group_memberships")
  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
}

// æ¨©é™ãƒã‚¹ã‚¿ãƒ¼
model Permission {
  id          String   @id @default(uuid())
  name        String   @unique // æ¨©é™åï¼ˆä¾‹: "slack:workspace:write", "earthquake:condition:read"ï¼‰
  displayName String   @map("display_name") // è¡¨ç¤ºåï¼ˆä¾‹: "Slackãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ç·¨é›†"ï¼‰
  description String?  @db.Text // æ¨©é™ã®èª¬æ˜
  category    String   // ã‚«ãƒ†ã‚´ãƒªï¼ˆä¾‹: "slack", "earthquake", "user"ï¼‰
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  groupAttachments GroupPermissionAttachment[]
  userAttachments  UserPermissionAttachment[]

  @@map("permissions")
  @@index([category])
  @@index([name])
}

// ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»æ¨©é™ã®ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆ
model GroupPermissionAttachment {
  id           String     @id @default(uuid())
  groupId      String     @map("group_id")
  group        Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  permissionId String     @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now()) @map("created_at")

  @@map("group_permission_attachments")
  @@unique([groupId, permissionId])
  @@index([groupId])
  @@index([permissionId])
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»æ¨©é™ã®ç›´æ¥ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆ
model UserPermissionAttachment {
  id           String     @id @default(uuid())
  userId       String     @map("user_id")
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permissionId String     @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now()) @map("created_at")

  @@map("user_permission_attachments")
  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
}

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒã‚¹ã‚¿ãƒ¼
model Menu {
  id                 String   @id @default(uuid())
  name               String   // ãƒ¡ãƒ‹ãƒ¥ãƒ¼åï¼ˆä¾‹: "ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹"ï¼‰
  path               String   @unique // ãƒ‘ã‚¹ï¼ˆä¾‹: "/admin/workspaces"ï¼‰
  icon               String   // ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆä¾‹: "ğŸ”—"ï¼‰
  displayOrder       Int      @map("display_order") // è¡¨ç¤ºé †åº
  isActive           Boolean  @default(true) @map("is_active")
  categoryPermission String   @map("category_permission") // ã“ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–²è¦§ã«å¿…è¦ãªæ¨©é™ï¼ˆä¾‹: "workspace:read"ï¼‰
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@map("menus")
  @@index([displayOrder])
  @@index([isActive])
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«
model UserWorkspace {
  id           String         @id @default(uuid())
  userId       String         @map("user_id")
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspaceRef String         @map("workspace_ref")
  workspace    SlackWorkspace @relation(fields: [workspaceRef], references: [id], onDelete: Cascade)
  createdAt    DateTime       @default(now()) @map("created_at")

  @@map("user_workspaces")
  @@unique([userId, workspaceRef])
  @@index([userId])
  @@index([workspaceRef])
}

model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
  @@index([userId])
  @@index([token])
}

model OtpCode {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  code      String   // 6æ¡æ•°å­—
  expiresAt DateTime @map("expires_at") // 5åˆ†å¾Œ
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("otp_codes")
  @@index([userId])
  @@index([code, expiresAt])
}

model UserInvitation {
  id           String         @id @default(uuid())
  email        String
  invitedBy    String         @map("invited_by")
  workspaceRef String         @map("workspace_ref") // æ‹›å¾…ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ï¼ˆå¿…é ˆï¼‰
  workspace    SlackWorkspace @relation(fields: [workspaceRef], references: [id], onDelete: Cascade)
  groupId      String         @map("group_id") // æ‹›å¾…æ™‚ã«æ‰€å±ã•ã›ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆå¿…é ˆï¼‰
  group        Group          @relation(fields: [groupId], references: [id])
  token        String         @unique
  role         UserRole       @default(EDITOR)
  expiresAt    DateTime       @map("expires_at") // 7æ—¥å¾Œ
  acceptedAt   DateTime?      @map("accepted_at")
  createdAt    DateTime       @default(now()) @map("created_at")

  inviter      User           @relation("InviterRelation", fields: [invitedBy], references: [id])

  @@map("user_invitations")
  @@index([email])
  @@index([token])
  @@index([groupId])
  @@index([workspaceRef])
}

// åœ°éœ‡æƒ…å ±è¨˜éŒ²ï¼ˆéœ‡åº¦3ä»¥ä¸Šï¼‰
model EarthquakeRecord {
  id              String                             @id @default(uuid())
  eventId         String                             @map("event_id")
  serialNo        Int                                @default(1) @map("serial_no") // é›»æ–‡ç•ªå·
  infoType        String                             @map("info_type") // VXSE51 or VXSE53
  title           String
  epicenter       String?                            // éœ‡æºåœ°
  magnitude       Float?                             // ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰
  depth           String?                            // éœ‡æºã®æ·±ã•
  maxIntensity    String                             @map("max_intensity") // æœ€å¤§éœ‡åº¦
  occurrenceTime  DateTime?                          @map("occurrence_time")
  arrivalTime     DateTime?                          @map("arrival_time")
  rawData         Json                               @map("raw_data")
  createdAt       DateTime                           @default(now()) @map("created_at")
  updatedAt       DateTime                           @default(now()) @updatedAt @map("updated_at")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  prefectureObservations EarthquakePrefectureObservation[]
  notifications          EarthquakeNotification[]

  @@map("earthquake_records")
  @@unique([eventId, serialNo])
  @@index([eventId])
  @@index([infoType])
  @@index([maxIntensity])
  @@index([occurrenceTime(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

// éƒ½é“åºœçœŒåˆ¥éœ‡åº¦è¨˜éŒ²
model EarthquakePrefectureObservation {
  id                  String           @id @default(uuid())
  earthquakeRecordId  String           @map("earthquake_record_id")
  earthquakeRecord    EarthquakeRecord @relation(fields: [earthquakeRecordId], references: [id], onDelete: Cascade)
  prefectureCode      String           @map("prefecture_code")
  prefecture          Prefecture       @relation(fields: [prefectureCode], references: [code])
  prefectureName      String           @map("prefecture_name")
  maxIntensity        String           @map("max_intensity")
  createdAt           DateTime         @default(now()) @map("created_at")

  @@map("earthquake_prefecture_observations")
  @@unique([earthquakeRecordId, prefectureCode])
  @@index([prefectureCode])
  @@index([maxIntensity])
}

// åœ°éœ‡é€šçŸ¥å±¥æ­´
model EarthquakeNotification {
  id                  String           @id @default(uuid())
  earthquakeRecordId  String           @map("earthquake_record_id")
  earthquakeRecord    EarthquakeRecord @relation(fields: [earthquakeRecordId], references: [id], onDelete: Cascade)
  workspaceId         String           @map("workspace_id")
  workspace           SlackWorkspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  channelId           String           @map("channel_id")
  messageTs           String?          @map("message_ts")
  notificationStatus  String           @default("pending") @map("notification_status") // pending, sent, failed
  errorMessage        String?          @map("error_message") @db.Text
  notifiedAt          DateTime?        @map("notified_at")
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @default(now()) @updatedAt @map("updated_at")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  safetyResponses     SafetyConfirmationResponse[]

  @@map("earthquake_notifications")
  @@index([workspaceId])
  @@index([notificationStatus])
  @@index([createdAt(sort: Desc)])
}

// å®‰å¦ç¢ºèªå›ç­”
model SafetyConfirmationResponse {
  id                     String                 @id @default(uuid())
  notificationId         String                 @map("notification_id")
  notification           EarthquakeNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  slackUserId            String                 @map("slack_user_id") // Slackãƒ¦ãƒ¼ã‚¶ãƒ¼ ID
  slackUserName          String                 @map("slack_user_name") // Slackãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆè¡¨ç¤ºç”¨ï¼‰
  departmentId           String                 @map("department_id")
  department             Department             @relation(fields: [departmentId], references: [id])
  respondedAt            DateTime               @default(now()) @map("responded_at")
  createdAt              DateTime               @default(now()) @map("created_at")

  @@map("safety_confirmation_responses")
  @@unique([notificationId, slackUserId])
  @@index([notificationId])
  @@index([slackUserId])
  @@index([departmentId])
  @@index([respondedAt(sort: Desc)])
}

// ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°
model ActivityLog {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userEmail    String   @map("user_email") // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å¾Œã‚‚è¨˜éŒ²ã‚’æ®‹ã™ãŸã‚
  action       String   // created, updated, deleted, connected, etc.
  resourceType String   @map("resource_type") // workspace, department, user, condition, etc.
  resourceId   String?  @map("resource_id")
  resourceName String?  @map("resource_name")
  details      String?  @db.Text // è¿½åŠ æƒ…å ±ï¼ˆJSONå½¢å¼ï¼‰
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("activity_logs")
  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt(sort: Desc)])
}

// DMData.jp OAuth2ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
model DmdataOAuthToken {
  id              String   @id @default(uuid())
  refreshToken    String   @unique @map("refresh_token") // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³
  dpopKeypair     Json?    @map("dpop_keypair") // DPoPéµãƒšã‚¢ï¼ˆJSONå½¢å¼ï¼‰
  codeVerifier    String?  @map("code_verifier") // PKCE Code Verifierï¼ˆä¸€æ™‚ä¿å­˜ï¼‰
  state           String?  @map("state") // OAuth stateï¼ˆä¸€æ™‚ä¿å­˜ï¼‰
  expiresAt       DateTime? @map("expires_at") // ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("dmdata_oauth_tokens")
  @@index([refreshToken])
  @@index([expiresAt])
}

// DMData.jp API Keyç®¡ç†
model DmdataApiKey {
  id          String   @id @default(uuid())
  apiKey      String   @map("api_key") // APIã‚­ãƒ¼ï¼ˆæš—å·åŒ–ä¿å­˜ï¼‰
  description String?  // ã‚­ãƒ¼ã®èª¬æ˜ï¼ˆä¾‹: "æœ¬ç•ªç”¨APIã‚­ãƒ¼"ï¼‰
  isActive    Boolean  @default(true) @map("is_active") // æœ‰åŠ¹/ç„¡åŠ¹
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("dmdata_api_keys")
  @@index([isActive])
}

// cron-job.org API Keyç®¡ç†
model CronJobApiKey {
  id          String   @id @default(uuid())
  apiKey      String   @map("api_key") // APIã‚­ãƒ¼ï¼ˆæš—å·åŒ–ä¿å­˜ï¼‰
  description String?  // ã‚­ãƒ¼ã®èª¬æ˜ï¼ˆä¾‹: "cron-job.org APIã‚­ãƒ¼"ï¼‰
  isActive    Boolean  @default(true) @map("is_active") // æœ‰åŠ¹/ç„¡åŠ¹
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("cronjob_api_keys")
  @@index([isActive])
}

// è¨“ç·´é€šçŸ¥å±¥æ­´
model TrainingNotification {
  id                  String           @id @default(uuid())
  workspaceId         String           @map("workspace_id")
  workspace           SlackWorkspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  channelId           String           @map("channel_id")
  messageTs           String?          @map("message_ts")
  notificationStatus  String           @default("pending") @map("notification_status") // pending, sent, failed
  errorMessage        String?          @map("error_message") @db.Text
  scheduledAt         DateTime?        @map("scheduled_at") // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é€ä¿¡æ™‚åˆ»ï¼ˆnullã®å ´åˆã¯å³æ™‚é€ä¿¡ï¼‰
  notifiedAt          DateTime?        @map("notified_at")
  cronJobId           String?          @map("cron_job_id") // cron-job.org ã®ã‚¸ãƒ§ãƒ–ID
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @default(now()) @updatedAt @map("updated_at")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  trainingResponses   TrainingConfirmationResponse[]

  @@map("training_notifications")
  @@index([workspaceId])
  @@index([notificationStatus])
  @@index([scheduledAt(sort: Asc)])
  @@index([createdAt(sort: Desc)])
  @@index([cronJobId])
}

// è¨“ç·´å®‰å¦ç¢ºèªå›ç­”
model TrainingConfirmationResponse {
  id                     String                 @id @default(uuid())
  trainingNotificationId String                 @map("training_notification_id")
  trainingNotification   TrainingNotification   @relation(fields: [trainingNotificationId], references: [id], onDelete: Cascade)
  slackUserId            String                 @map("slack_user_id") // Slackãƒ¦ãƒ¼ã‚¶ãƒ¼ ID
  slackUserName          String                 @map("slack_user_name") // Slackãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆè¡¨ç¤ºç”¨ï¼‰
  departmentId           String                 @map("department_id")
  department             Department             @relation(fields: [departmentId], references: [id])
  respondedAt            DateTime               @default(now()) @map("responded_at")
  createdAt              DateTime               @default(now()) @map("created_at")

  @@map("training_confirmation_responses")
  @@unique([trainingNotificationId, slackUserId])
  @@index([trainingNotificationId])
  @@index([slackUserId])
  @@index([departmentId])
  @@index([respondedAt(sort: Desc)])
}

// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³
model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  used      Boolean  @default(false)
  usedAt    DateTime? @map("used_at")

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// AWSèªè¨¼æƒ…å ±ï¼ˆEventBridge Schedulerç”¨ï¼‰
model AwsCredential {
  id                   String   @id @default(uuid())
  accessKeyId          String   @map("access_key_id")          // æš—å·åŒ–ä¿å­˜
  secretAccessKey      String   @map("secret_access_key")      // æš—å·åŒ–ä¿å­˜
  region               String   @default("ap-northeast-1")     // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
  eventBridgeRoleArn   String?  @map("eventbridge_role_arn")   // EventBridgeå®Ÿè¡Œãƒ­ãƒ¼ãƒ«ARNï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  apiDestinationArn    String?  @map("api_destination_arn")    // API Destination ARNï¼ˆä½œæˆå¾Œã«ä¿å­˜ï¼‰
  connectionArn        String?  @map("connection_arn")         // Connection ARNï¼ˆä½œæˆå¾Œã«ä¿å­˜ï¼‰
  isActive             Boolean  @default(true) @map("is_active")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@map("aws_credentials")
}

// ãƒ‘ã‚¹ã‚­ãƒ¼ï¼ˆWebAuthnèªè¨¼ï¼‰
model Passkey {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // WebAuthn Credentialæƒ…å ±
  credentialId Bytes     @unique @map("credential_id") // Base64ãƒ‡ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ã®Credential ID
  publicKey    Bytes     @map("public_key")            // COSEå½¢å¼ã®å…¬é–‹éµ
  counter      BigInt    @default(0)                   // ç½²åã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒé˜²æ­¢ï¼‰

  // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±
  deviceName   String?   @map("device_name")           // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®ãƒ‡ãƒã‚¤ã‚¹åï¼ˆä¾‹: "MacBook Pro"ï¼‰
  transports   String[]  @default([])                  // ["usb", "nfc", "ble", "internal"]

  // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  createdAt    DateTime  @default(now()) @map("created_at")
  lastUsedAt   DateTime? @map("last_used_at")

  @@map("passkeys")
  @@index([userId])
}

// WebAuthnãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆç™»éŒ²ãƒ»èªè¨¼æ™‚ã®ä½¿ã„æ¨ã¦ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
model WebAuthnChallenge {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")           // ç™»éŒ²æ™‚ã¯nullã€èªè¨¼æ™‚ã¯è¨­å®š
  challenge  String   @unique                   // ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã•ã‚ŒãŸãƒãƒ£ãƒ¬ãƒ³ã‚¸æ–‡å­—åˆ—
  type       String                             // "registration" | "authentication"
  expiresAt  DateTime @map("expires_at")        // æœ‰åŠ¹æœŸé™ï¼ˆé€šå¸¸60ç§’ï¼‰
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("webauthn_challenges")
  @@index([userId])
  @@index([expiresAt])
  @@index([challenge])
}

// ãƒ‘ã‚¹ã‚­ãƒ¼å†ç™»éŒ²ãƒˆãƒ¼ã‚¯ãƒ³
model PasskeyResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")         // 24æ™‚é–“æœ‰åŠ¹
  createdAt DateTime @default(now()) @map("created_at")
  used      Boolean  @default(false)
  usedAt    DateTime? @map("used_at")

  @@map("passkey_reset_tokens")
  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// é€šçŸ¥ã‚¹ãƒŒãƒ¼ã‚ºè¨­å®šï¼ˆæ™‚é–“å˜ä½ã§è¨­å®šå¯èƒ½ï¼‰
model NotificationSnoozeConfig {
  id                String         @id @default(uuid())
  workspaceRef      String         @unique @map("workspace_ref")
  workspace         SlackWorkspace @relation(fields: [workspaceRef], references: [id], onDelete: Cascade)
  durationHours     Int            @default(24) @map("duration_hours") // ã‚¹ãƒŒãƒ¼ã‚ºæ™‚é–“ï¼ˆæ™‚é–“å˜ä½ï¼‰
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  @@map("notification_snooze_configs")
  @@index([workspaceRef])
}

// é€šçŸ¥ã‚¹ãƒŒãƒ¼ã‚ºçŠ¶æ…‹
model NotificationSnooze {
  id           String         @id @default(uuid())
  workspaceRef String         @unique @map("workspace_ref")
  workspace    SlackWorkspace @relation(fields: [workspaceRef], references: [id], onDelete: Cascade)
  snoozedBy    String         @map("snoozed_by") // ã‚¹ãƒŒãƒ¼ã‚ºã‚’å®Ÿè¡Œã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  snoozedAt    DateTime       @default(now()) @map("snoozed_at")
  expiresAt    DateTime       @map("expires_at")
  createdAt    DateTime       @default(now()) @map("created_at")

  @@map("notification_snoozes")
  @@index([workspaceRef])
  @@index([expiresAt])
}
